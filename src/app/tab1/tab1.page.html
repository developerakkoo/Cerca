<ion-content 
  [fullscreen]="true"
  class="tab1-content"
  [scrollY]="false">
  
  <!-- Map Container - Shown on load and in confirm mode -->
  <div class="map-container" *ngIf="confirmMode || (showMapOnLoad && confirmLat && confirmLng)">
    <capacitor-google-map #map id="tab1-map"></capacitor-google-map>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="!isMapReady && !mapError">
      <div class="loading-container">
        <ion-spinner></ion-spinner>
        <p>Loading map...</p>
      </div>
    </div>

    <!-- Error State -->
    <div class="error-overlay" *ngIf="mapError && !isMapReady">
      <div class="error-container">
        <ion-icon name="alert-circle-outline" color="danger" size="large"></ion-icon>
        <p class="error-message">{{ mapError }}</p>
        <div class="error-actions">
          <ion-button (click)="initializeMap()" fill="solid">Retry</ion-button>
          <ion-button (click)="cancelConfirm()" fill="outline">Cancel</ion-button>
        </div>
      </div>
    </div>

    <!-- Fixed Center Pin Overlay -->
    <div class="center-pin-overlay" *ngIf="isMapReady">
      <div class="center-pin">
        <ion-icon name="location" class="pin-icon"></ion-icon>
        <div class="pin-shadow"></div>
      </div>
    </div>

    <!-- Address Card - Only shown in confirm mode -->
    <div class="address-card" *ngIf="isMapReady && confirmMode">
      <div class="address-content">
        <ion-icon name="location-outline"></ion-icon>
        <div class="address-text">
          <div *ngIf="isLoadingAddress" class="address-loading">
            <ion-spinner name="crescent"></ion-spinner>
            <span>Updating address...</span>
          </div>
          <div *ngIf="!isLoadingAddress" class="address-value">
            {{ confirmAddress || 'Loading address...' }}
          </div>
        </div>
      </div>
      <!-- Confirm Button inside address card -->
      <div class="address-card-actions">
        <ion-button class="confirm-button" (click)="confirmLocation()" expand="block">
          Confirm Address
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Inputs Mode - Only shown when not in confirm mode -->
  <div *ngIf="!confirmMode">
    <!-- Floating Input Section - Always at top -->
    <div class="floating-inputs">
      <!-- Pickup Input Card -->
      <div class="input-card pickup-card" (click)="onInputFocus('pickup')">
        <div class="input-icon-wrapper pickup-icon">
          <ion-icon name="location-outline"></ion-icon>
        </div>
        <div class="input-content">
          <span *ngIf="!pickupAddress" class="input-placeholder">Pickup location</span>
          <span *ngIf="pickupAddress" class="input-value">{{ pickupAddress }}</span>
        </div>
      </div>

      <!-- Destination Input Card -->
      <div class="input-card destination-card" (click)="onInputFocus('destination')">
        <div class="input-icon-wrapper destination-icon">
          <ion-icon name="navigate-outline"></ion-icon>
        </div>
        <div class="input-content">
          <span *ngIf="!destinationAddress" class="input-placeholder">Where to?</span>
          <span *ngIf="destinationAddress" class="input-value">{{ destinationAddress }}</span>
        </div>
      </div>
    </div>

    <!-- Ride Cards Section - Only shown when both addresses are set -->
    <div class="ride-cards-section" *ngIf="pickupAddress && destinationAddress">
    <h3 class="section-title">Choose a trip</h3>
    
    <!-- Loading State -->
    <div *ngIf="isLoadingServices || isCalculatingFares" class="ride-cards-loading">
      <ion-spinner></ion-spinner>
      <p>Finding available rides...</p>
    </div>

    <!-- Ride Cards Vertical List -->
    <div class="ride-cards-container" *ngIf="!isLoadingServices && vehicleServices && !isCalculatingFares">
      <ion-radio-group [(ngModel)]="selectedVehicle" (ionChange)="onVehicleSelect($event)">
        
        <!-- Small Ride Card -->
        <div class="ride-card" 
             *ngIf="vehicleServices.cercaSmall?.enabled"
             [class.selected]="selectedVehicle === 'small'"
             (click)="selectedVehicle = 'small'">
          <div class="vehicle-image-wrapper">
            <img [src]="vehicleServices.cercaSmall?.imagePath || 'assets/cars/cerca-small.png'" 
                 alt="Small"
                 onerror="this.src='assets/cars/cerca-small.png'">
          </div>
          <div class="ride-info">
            <h4 class="ride-name">{{ vehicleServices.cercaSmall?.name || 'Small' }}</h4>
            <p class="ride-eta">{{ vehicleETAs.small || '2-4 min' }} away</p>
          </div>
          <div class="ride-price-radio">
            <p class="ride-price">
              <span *ngIf="calculatedFares?.cercaSmall">₹{{ calculatedFares?.cercaSmall?.finalFare }}</span>
              <span *ngIf="!calculatedFares?.cercaSmall">₹{{ vehicleServices.cercaSmall?.price || 299 }}</span>
            </p>
            <ion-radio value="small" mode="md" class="ride-radio"></ion-radio>
          </div>
        </div>

        <!-- Medium Ride Card -->
        <div class="ride-card" 
             *ngIf="vehicleServices.cercaMedium?.enabled"
             [class.selected]="selectedVehicle === 'medium'"
             (click)="selectedVehicle = 'medium'">
          <div class="vehicle-image-wrapper">
            <img [src]="vehicleServices.cercaMedium?.imagePath || 'assets/cars/Cerca-medium.png'" 
                 alt="Medium"
                 onerror="this.src='assets/cars/Cerca-medium.png'">
          </div>
          <div class="ride-info">
            <h4 class="ride-name">{{ vehicleServices.cercaMedium?.name || 'Medium' }}</h4>
            <p class="ride-eta">{{ vehicleETAs.medium || '3-5 min' }} away</p>
          </div>
          <div class="ride-price-radio">
            <p class="ride-price">
              <span *ngIf="calculatedFares?.cercaMedium">₹{{ calculatedFares?.cercaMedium?.finalFare }}</span>
              <span *ngIf="!calculatedFares?.cercaMedium">₹{{ vehicleServices.cercaMedium?.price || 499 }}</span>
            </p>
            <ion-radio value="medium" mode="md" class="ride-radio"></ion-radio>
          </div>
        </div>

        <!-- Large Ride Card -->
        <div class="ride-card" 
             *ngIf="vehicleServices.cercaLarge?.enabled"
             [class.selected]="selectedVehicle === 'large'"
             (click)="selectedVehicle = 'large'">
          <div class="vehicle-image-wrapper">
            <img [src]="vehicleServices.cercaLarge?.imagePath || 'assets/cars/cerca-large.png'" 
                 alt="Large"
                 onerror="this.src='assets/cars/cerca-large.png'">
          </div>
          <div class="ride-info">
            <h4 class="ride-name">{{ vehicleServices.cercaLarge?.name || 'Large' }}</h4>
            <p class="ride-eta">{{ vehicleETAs.large || '4-6 min' }} away</p>
          </div>
          <div class="ride-price-radio">
            <p class="ride-price">
              <span *ngIf="calculatedFares?.cercaLarge">₹{{ calculatedFares?.cercaLarge?.finalFare }}</span>
              <span *ngIf="!calculatedFares?.cercaLarge">₹{{ vehicleServices.cercaLarge?.price || 699 }}</span>
            </p>
            <ion-radio value="large" mode="md" class="ride-radio"></ion-radio>
          </div>
        </div>

      </ion-radio-group>
      
      <!-- Book Now Button -->
      <div class="book-now-wrapper" *ngIf="selectedVehicle">
        <button class="book-now-btn" (click)="goToPayment()">
          <span class="btn-text">Book Now</span>
          <ion-icon name="arrow-forward-outline"></ion-icon>
        </button>
      </div>
    </div>
    </div>
  </div>
  <!-- End Inputs Mode -->

</ion-content>

  <ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-title>
      {{ 'BOOKINGS.title' | translate }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="false" class="ion-padding">
  <ion-header collapse="condense" class="ion-no-border">
    <ion-toolbar>
      <ion-title size="large">{{ 'BOOKINGS.title' | translate }}</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="segment-container">
    <ion-segment color="primary" value="active" (ionChange)="segmentChanged($event)" >
      <ion-segment-button value="active" content-id="active">
        <ion-label>{{ 'BOOKINGS.activeNow' | translate }}</ion-label>
      </ion-segment-button>
      <ion-segment-button value="past">
        <ion-label>{{ 'BOOKINGS.pastBookings' | translate }}</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>

  <!-- Active Rides Section -->
  <div *ngIf="isActive">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="ion-text-center ion-padding">
      <ion-spinner></ion-spinner>
      <p>{{ 'BOOKINGS.loadingRides' | translate }}</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && activeBookings.length === 0" class="ion-text-center ion-padding">
      <ion-icon name="car-outline" size="large" color="medium"></ion-icon>
      <h3>{{ 'BOOKINGS.noActiveRides' | translate }}</h3>
      <p>{{ 'BOOKINGS.noActiveRidesDesc' | translate }}</p>
    </div>

    <!-- Active Rides List -->
    <ion-list *ngIf="!isLoading && activeBookings.length > 0" class="rides-list">
      <ion-card *ngFor="let booking of displayedActiveBookings">
        <ion-card-header>
          <ion-card-title>
            Ride #{{ booking._id.slice(-6) }}
          </ion-card-title>
          <ion-card-subtitle>
            {{ formatDate(booking.createdAt) }} at {{ formatTime(booking.createdAt) }}
          </ion-card-subtitle>
        </ion-card-header>
      
        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-label><strong>{{ 'BOOKINGS.driver' | translate }}:</strong></ion-label>
                <ion-text>{{ getDriverName(booking) }}</ion-text>
              </ion-col>
              <ion-col size="6">
                <ion-label><strong>{{ 'BOOKINGS.vehicle' | translate }}:</strong></ion-label>
                <ion-text>{{ getVehicleInfo(booking) }}</ion-text>
              </ion-col>
            </ion-row>
      
            <ion-row>
              <ion-col size="12">
                <ion-label><strong>{{ 'BOOKINGS.pickup' | translate }}:</strong></ion-label>
                <ion-text>{{ booking.pickupAddress || 'N/A' }}</ion-text>
              </ion-col>
            </ion-row>
      
            <ion-row>
              <ion-col size="12">
                <ion-label><strong>{{ 'BOOKINGS.destination' | translate }}:</strong></ion-label>
                <ion-text>{{ booking.dropoffAddress || 'N/A' }}</ion-text>
              </ion-col>
            </ion-row>
      
            <ion-row>
              <ion-col size="6">
                <ion-label><strong>{{ 'BOOKINGS.fare' | translate }}:</strong></ion-label>
                <ion-text>₹{{ booking.fare || 'N/A' }}</ion-text>
              </ion-col>
              <ion-col size="6">
                <ion-label><strong>{{ 'BOOKINGS.status' | translate }}:</strong></ion-label>
                <ion-text [color]="getStatusColor(booking.status)">
                  {{ getStatusText(booking.status) }}
                </ion-text>
              </ion-col>
            </ion-row>
      
            <ion-row>
              <ion-col size="6">
                <ion-button 
                  expand="block" 
                  mode="ios" 
                  (click)="navigateToActiveRide(booking._id, booking)" 
                  class="view-details-btn"
                  [disabled]="booking.status === 'requested' || !isRideDetailsEnabled(booking)">
                  <ion-icon name="information-circle-outline" slot="start"></ion-icon>
                  {{ 'BOOKINGS.viewDetails' | translate }}
                </ion-button>
                <p *ngIf="booking.bookingType === 'FULL_DAY' && !isRideDetailsEnabled(booking)" 
                   class="disabled-hint" 
                   style="font-size: 0.75rem; color: var(--ion-color-medium); margin-top: 4px; text-align: center;">
                  Available on scheduled date/time
                </p>
              </ion-col>
              <ion-col size="6">
                <!-- Timer button for requested rides -->
                <ion-button 
                  *ngIf="booking.status === 'requested'"
                  expand="block" 
                  mode="ios" 
                  (click)="cancelRideImmediately(booking)" 
                  class="timer-btn"
                  [class.timer-low]="isTimerLow(booking)"
                  color="warning">
                  <ion-icon name="time-outline" slot="start"></ion-icon>
                  Cancel ({{ getTimerText(booking) }})
                </ion-button>
                <!-- Call driver button for accepted/in_progress rides -->
                <ion-button 
                  *ngIf="booking.status !== 'requested'"
                  expand="block" 
                  mode="ios" 
                  (click)="callDriver(booking.driver?.phone)" 
                  class="call-driver-btn"
                  [disabled]="!booking.driver?.phone">
                  <ion-icon name="call-outline" slot="start"></ion-icon>
                  {{ 'BOOKINGS.callDriver' | translate }}
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>
    </ion-list>

    <!-- Load More Button for Active Rides -->
    <div *ngIf="!isLoading && hasMoreActive()" class="ion-text-center ion-padding">
      <ion-button 
        expand="block" 
        fill="outline" 
        (click)="loadMoreActive()"
        class="load-more-btn">
        <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
        Load More ({{ activeBookings.length - activeDisplayCount }} remaining)
      </ion-button>
    </div>
  </div>

  <!-- Past Rides Section -->
  <div *ngIf="!isActive">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="ion-text-center ion-padding">
      <ion-spinner></ion-spinner>
      <p>{{ 'BOOKINGS.loadingRides' | translate }}</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && pastBookings.length === 0" class="ion-text-center ion-padding">
      <ion-icon name="time-outline" size="large" color="medium"></ion-icon>
      <h3>{{ 'BOOKINGS.noPastRides' | translate }}</h3>
      <p>{{ 'BOOKINGS.noPastRidesDesc' | translate }}</p>
    </div>

    <!-- Past Rides List -->
    <ion-list *ngIf="!isLoading && pastBookings.length > 0" class="rides-list">
  <ion-card *ngFor="let booking of displayedPastBookings">
    <ion-card-header>
      <ion-card-title color="light">
        Ride #{{ booking._id.slice(-6) }}
      </ion-card-title>
      <ion-card-subtitle>
        {{ formatDate(booking.createdAt) }} at {{ formatTime(booking.createdAt) }}
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <ion-label><strong>{{ 'BOOKINGS.driver' | translate }}:</strong></ion-label>
            <ion-text>{{ getDriverName(booking) }}</ion-text>
          </ion-col>
          <ion-col size="6">
            <ion-label><strong>{{ 'BOOKINGS.vehicle' | translate }}:</strong></ion-label>
            <ion-text>{{ getVehicleInfo(booking) }}</ion-text>
          </ion-col>
        </ion-row>
  
        <ion-row>
          <ion-col size="12">
            <ion-label><strong>{{ 'BOOKINGS.pickup' | translate }}:</strong></ion-label>
            <ion-text>{{ booking.pickupAddress || 'N/A' }}</ion-text>
          </ion-col>
        </ion-row>
  
        <ion-row>
          <ion-col size="12">
            <ion-label><strong>{{ 'BOOKINGS.destination' | translate }}:</strong></ion-label>
            <ion-text>{{ booking.dropoffAddress || 'N/A' }}</ion-text>
          </ion-col>
        </ion-row>
  
        <ion-row>
          <ion-col size="6">
            <ion-label><strong>{{ 'BOOKINGS.fare' | translate }}:</strong></ion-label>
            <ion-text>₹{{ booking.fare || 'N/A' }}</ion-text>
          </ion-col>
          <ion-col size="6">
            <ion-label><strong>{{ 'BOOKINGS.status' | translate }}:</strong></ion-label>
            <ion-text [color]="getStatusColor(booking.status)">
              {{ getStatusText(booking.status) }}
            </ion-text>
          </ion-col>
        </ion-row>

        <ion-row *ngIf="booking.actualEndTime">
          <ion-col size="12">
            <ion-label><strong>Completed:</strong></ion-label>
            <ion-text>{{ formatDate(booking.actualEndTime) }} at {{ formatTime(booking.actualEndTime) }}</ion-text>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>
</ion-list>

    <!-- Load More Button for Past Rides -->
    <div *ngIf="!isLoading && hasMorePast()" class="ion-text-center ion-padding">
      <ion-button 
        expand="block" 
        fill="outline" 
        (click)="loadMorePast()"
        class="load-more-btn">
        <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
        Load More ({{ pastBookings.length - pastDisplayCount }} remaining)
      </ion-button>
    </div>
  </div>
</ion-content>

  <ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-title>
      {{ 'BOOKINGS.title' | translate }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="false" class="ion-padding">
  <ion-header collapse="condense" class="ion-no-border">
    <ion-toolbar>
      <ion-title size="large">{{ 'BOOKINGS.title' | translate }}</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="segment-container">
    <ion-segment color="primary" value="active" (ionChange)="segmentChanged($event)" >
      <ion-segment-button value="active" content-id="active">
        <ion-label>{{ 'BOOKINGS.activeNow' | translate }}</ion-label>
      </ion-segment-button>
      <ion-segment-button value="past">
        <ion-label>{{ 'BOOKINGS.pastBookings' | translate }}</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>

  <!-- Active Rides Section -->
  <div *ngIf="isActive">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="ion-text-center ion-padding">
      <ion-spinner></ion-spinner>
      <p>{{ 'BOOKINGS.loadingRides' | translate }}</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && activeBookings.length === 0" class="ion-text-center ion-padding">
      <ion-icon name="car-outline" size="large" color="medium"></ion-icon>
      <h3>{{ 'BOOKINGS.noActiveRides' | translate }}</h3>
      <p>{{ 'BOOKINGS.noActiveRidesDesc' | translate }}</p>
    </div>

    <!-- Active Rides List -->
    <ion-list *ngIf="!isLoading && activeBookings.length > 0" class="rides-list">
      <ion-card *ngFor="let booking of displayedActiveBookings; let i = index" class="booking-card active-booking" [style.animation-delay]="(i * 0.1) + 's'">
        <!-- Status Accent Bar -->
        <div class="status-accent" [class]="'status-' + booking.status"></div>
        
        <ion-card-header class="card-header">
          <div class="header-content">
            <div class="ride-info">
              <ion-card-title class="ride-date-time">
                {{ formatDate(booking.createdAt) }} at {{ formatTime(booking.createdAt) }}
              </ion-card-title>
            </div>
            <div class="status-badge" [class]="'badge-' + getStatusColor(booking.status)">
              {{ getStatusText(booking.status) }}
            </div>
          </div>
        </ion-card-header>
      
        <ion-card-content class="card-content">
          <!-- Action Buttons -->
          <div class="action-buttons">
            <ion-button 
              expand="block" 
              mode="ios" 
              (click)="navigateToActiveRide(booking._id, booking)" 
              class="view-details-btn"
              [disabled]="booking.status === 'requested' || !isRideDetailsEnabled(booking)">
              <ion-icon name="information-circle-outline" slot="start"></ion-icon>
              {{ 'BOOKINGS.viewDetails' | translate }}
            </ion-button>
            <p *ngIf="booking.bookingType === 'FULL_DAY' && !isRideDetailsEnabled(booking)" 
               class="disabled-hint">
              Available on scheduled date/time
            </p>
            
            <!-- Timer button for requested rides -->
            <ion-button 
              *ngIf="booking.status === 'requested'"
              expand="block" 
              mode="ios" 
              (click)="cancelRideImmediately(booking)" 
              class="timer-btn"
              [class.timer-low]="isTimerLow(booking)"
              color="warning">
              <ion-icon name="time-outline" slot="start"></ion-icon>
              Cancel ({{ getTimerText(booking) }})
            </ion-button>
            <!-- Call driver button for accepted/in_progress rides -->
            <ion-button 
              *ngIf="booking.status !== 'requested'"
              expand="block" 
              mode="ios" 
              (click)="callDriver(booking.driver?.phone)" 
              class="call-driver-btn"
              [disabled]="!booking.driver?.phone">
              <ion-icon name="call-outline" slot="start"></ion-icon>
              {{ 'BOOKINGS.callDriver' | translate }}
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-list>

    <!-- Load More Button for Active Rides -->
    <div *ngIf="!isLoading && hasMoreActive()" class="ion-text-center ion-padding">
      <ion-button 
        expand="block" 
        fill="outline" 
        (click)="loadMoreActive()"
        class="load-more-btn">
        <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
        Load More ({{ activeBookings.length - activeDisplayCount }} remaining)
      </ion-button>
    </div>
  </div>

  <!-- Past Rides Section -->
  <div *ngIf="!isActive">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="ion-text-center ion-padding">
      <ion-spinner></ion-spinner>
      <p>{{ 'BOOKINGS.loadingRides' | translate }}</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && pastBookings.length === 0" class="ion-text-center ion-padding">
      <ion-icon name="time-outline" size="large" color="medium"></ion-icon>
      <h3>{{ 'BOOKINGS.noPastRides' | translate }}</h3>
      <p>{{ 'BOOKINGS.noPastRidesDesc' | translate }}</p>
    </div>

    <!-- Past Rides List -->
    <ion-list *ngIf="!isLoading && pastBookings.length > 0" class="rides-list">
      <ion-card *ngFor="let booking of displayedPastBookings; let i = index" class="booking-card past-booking" [style.animation-delay]="(i * 0.1) + 's'">
        <!-- Status Accent Bar -->
        <div class="status-accent" [class]="'status-' + booking.status"></div>
        
        <ion-card-header class="card-header">
          <div class="header-content">
            <div class="ride-info">
              <ion-card-title class="ride-date-time">
                {{ formatDate(booking.createdAt) }} at {{ formatTime(booking.createdAt) }}
              </ion-card-title>
            </div>
            <div class="badge-container">
              <div class="status-badge" [class]="'badge-' + getStatusColor(booking.status)">
                {{ getStatusText(booking.status) }}
              </div>
              <!-- Payment Pending Badge -->
              <div *ngIf="isPaymentPending(booking)" class="payment-pending-badge">
                Payment Pending
              </div>
            </div>
          </div>
        </ion-card-header>
        
        <ion-card-content class="card-content">
          <!-- Ride Information -->
          <div class="ride-details">
            <div class="detail-row">
              <ion-icon name="key-outline" class="detail-icon"></ion-icon>
              <div class="detail-content">
                <span class="detail-label">Ride ID:</span>
                <span class="detail-value">{{ booking._id }}</span>
              </div>
            </div>
            
            <div class="detail-row">
              <ion-icon name="location-outline" class="detail-icon"></ion-icon>
              <div class="detail-content">
                <span class="detail-label">Pickup:</span>
                <span class="detail-value">{{ booking.pickupAddress || 'N/A' }}</span>
              </div>
            </div>
            
            <div class="detail-row">
              <ion-icon name="navigate-outline" class="detail-icon"></ion-icon>
              <div class="detail-content">
                <span class="detail-label">Dropoff:</span>
                <span class="detail-value">{{ booking.dropoffAddress || 'N/A' }}</span>
              </div>
            </div>
          </div>
          
          <!-- Payment Action Button (shown when payment is pending) -->
          <div *ngIf="isPaymentPending(booking)" class="payment-action">
            <ion-button 
              expand="block" 
              mode="ios" 
              color="primary"
              (click)="navigateToPayment(booking._id, booking.fare, booking)"
              class="pay-now-btn">
              <ion-icon name="card-outline" slot="start"></ion-icon>
              Pay â‚¹{{ booking.fare.toFixed(2) }}
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-list>

  </div>
</ion-content>

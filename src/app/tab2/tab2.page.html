  <ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-title>
      {{ 'BOOKINGS.title' | translate }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="false" class="ion-padding">
  <ion-header collapse="condense" class="ion-no-border">
    <ion-toolbar>
      <ion-title size="large">{{ 'BOOKINGS.title' | translate }}</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="segment-container">
    <ion-segment color="primary" value="active" (ionChange)="segmentChanged($event)" >
      <ion-segment-button value="active" content-id="active">
        <ion-label>{{ 'BOOKINGS.activeNow' | translate }}</ion-label>
      </ion-segment-button>
      <ion-segment-button value="past">
        <ion-label>{{ 'BOOKINGS.pastBookings' | translate }}</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>

  <!-- Active Rides Section -->
  <div *ngIf="isActive">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="ion-text-center ion-padding">
      <ion-spinner></ion-spinner>
      <p>{{ 'BOOKINGS.loadingRides' | translate }}</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && activeBookings.length === 0" class="ion-text-center ion-padding">
      <ion-icon name="car-outline" size="large" color="medium"></ion-icon>
      <h3>{{ 'BOOKINGS.noActiveRides' | translate }}</h3>
      <p>{{ 'BOOKINGS.noActiveRidesDesc' | translate }}</p>
    </div>

    <!-- Active Rides List -->
    <ion-list *ngIf="!isLoading && activeBookings.length > 0" class="rides-list">
      <ion-card *ngFor="let booking of displayedActiveBookings; let i = index" class="booking-card active-booking" [style.animation-delay]="(i * 0.1) + 's'">
        <!-- Status Accent Bar -->
        <div class="status-accent" [class]="'status-' + booking.status"></div>
        
        <ion-card-header class="card-header">
          <div class="header-content">
            <div class="ride-info">
              <ion-card-title class="ride-id">Ride #{{ booking._id.slice(-6) }}</ion-card-title>
              <ion-card-subtitle class="ride-date">
                <ion-icon name="time-outline"></ion-icon>
                {{ formatDate(booking.createdAt) }} at {{ formatTime(booking.createdAt) }}
              </ion-card-subtitle>
            </div>
            <div class="status-badge" [class]="'badge-' + getStatusColor(booking.status)">
              {{ getStatusText(booking.status) }}
            </div>
          </div>
        </ion-card-header>
      
        <ion-card-content class="card-content">
          <!-- Driver & Vehicle Info -->
          <div class="info-row">
            <div class="info-item">
              <ion-icon name="person-outline" class="info-icon"></ion-icon>
              <div class="info-content">
                <span class="info-label">{{ 'BOOKINGS.driver' | translate }}</span>
                <span class="info-value">{{ getDriverName(booking) }}</span>
              </div>
            </div>
            <div class="info-item">
              <ion-icon name="car-outline" class="info-icon"></ion-icon>
              <div class="info-content">
                <span class="info-label">{{ 'BOOKINGS.vehicle' | translate }}</span>
                <span class="info-value">{{ getVehicleInfo(booking) }}</span>
              </div>
            </div>
          </div>

          <!-- Pickup Location -->
          <div class="location-row">
            <ion-icon name="location" class="location-icon pickup-icon"></ion-icon>
            <div class="location-content">
              <span class="location-label">{{ 'BOOKINGS.pickup' | translate }}</span>
              <span class="location-value">{{ booking.pickupAddress || 'N/A' }}</span>
            </div>
          </div>

          <!-- Destination Location -->
          <div class="location-row">
            <ion-icon name="location" class="location-icon destination-icon"></ion-icon>
            <div class="location-content">
              <span class="location-label">{{ 'BOOKINGS.destination' | translate }}</span>
              <span class="location-value">{{ booking.dropoffAddress || 'N/A' }}</span>
            </div>
          </div>

          <!-- Fare Display -->
          <div class="fare-section">
            <div class="fare-label">{{ 'BOOKINGS.fare' | translate }}</div>
            <div class="fare-amount">₹{{ booking.fare || 'N/A' }}</div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <ion-button 
              expand="block" 
              mode="ios" 
              (click)="navigateToActiveRide(booking._id, booking)" 
              class="view-details-btn"
              [disabled]="booking.status === 'requested' || !isRideDetailsEnabled(booking)">
              <ion-icon name="information-circle-outline" slot="start"></ion-icon>
              {{ 'BOOKINGS.viewDetails' | translate }}
            </ion-button>
            <p *ngIf="booking.bookingType === 'FULL_DAY' && !isRideDetailsEnabled(booking)" 
               class="disabled-hint">
              Available on scheduled date/time
            </p>
            
            <!-- Timer button for requested rides -->
            <ion-button 
              *ngIf="booking.status === 'requested'"
              expand="block" 
              mode="ios" 
              (click)="cancelRideImmediately(booking)" 
              class="timer-btn"
              [class.timer-low]="isTimerLow(booking)"
              color="warning">
              <ion-icon name="time-outline" slot="start"></ion-icon>
              Cancel ({{ getTimerText(booking) }})
            </ion-button>
            <!-- Call driver button for accepted/in_progress rides -->
            <ion-button 
              *ngIf="booking.status !== 'requested'"
              expand="block" 
              mode="ios" 
              (click)="callDriver(booking.driver?.phone)" 
              class="call-driver-btn"
              [disabled]="!booking.driver?.phone">
              <ion-icon name="call-outline" slot="start"></ion-icon>
              {{ 'BOOKINGS.callDriver' | translate }}
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-list>

    <!-- Load More Button for Active Rides -->
    <div *ngIf="!isLoading && hasMoreActive()" class="ion-text-center ion-padding">
      <ion-button 
        expand="block" 
        fill="outline" 
        (click)="loadMoreActive()"
        class="load-more-btn">
        <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
        Load More ({{ activeBookings.length - activeDisplayCount }} remaining)
      </ion-button>
    </div>
  </div>

  <!-- Past Rides Section -->
  <div *ngIf="!isActive">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="ion-text-center ion-padding">
      <ion-spinner></ion-spinner>
      <p>{{ 'BOOKINGS.loadingRides' | translate }}</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && pastBookings.length === 0" class="ion-text-center ion-padding">
      <ion-icon name="time-outline" size="large" color="medium"></ion-icon>
      <h3>{{ 'BOOKINGS.noPastRides' | translate }}</h3>
      <p>{{ 'BOOKINGS.noPastRidesDesc' | translate }}</p>
    </div>

    <!-- Past Rides List -->
    <ion-list *ngIf="!isLoading && pastBookings.length > 0" class="rides-list">
      <ion-card *ngFor="let booking of displayedPastBookings; let i = index" class="booking-card past-booking" [style.animation-delay]="(i * 0.1) + 's'">
        <!-- Status Accent Bar -->
        <div class="status-accent" [class]="'status-' + booking.status"></div>
        
        <ion-card-header class="card-header">
          <div class="header-content">
            <div class="ride-info">
              <ion-card-title class="ride-id">Ride #{{ booking._id.slice(-6) }}</ion-card-title>
              <ion-card-subtitle class="ride-date">
                <ion-icon name="time-outline"></ion-icon>
                {{ formatDate(booking.createdAt) }} at {{ formatTime(booking.createdAt) }}
              </ion-card-subtitle>
            </div>
            <div class="status-badge" [class]="'badge-' + getStatusColor(booking.status)">
              {{ getStatusText(booking.status) }}
            </div>
          </div>
        </ion-card-header>
        
        <ion-card-content class="card-content">
          <!-- Driver & Vehicle Info -->
          <div class="info-row">
            <div class="info-item">
              <ion-icon name="person-outline" class="info-icon"></ion-icon>
              <div class="info-content">
                <span class="info-label">{{ 'BOOKINGS.driver' | translate }}</span>
                <span class="info-value">{{ getDriverName(booking) }}</span>
              </div>
            </div>
            <div class="info-item">
              <ion-icon name="car-outline" class="info-icon"></ion-icon>
              <div class="info-content">
                <span class="info-label">{{ 'BOOKINGS.vehicle' | translate }}</span>
                <span class="info-value">{{ getVehicleInfo(booking) }}</span>
              </div>
            </div>
          </div>

          <!-- Pickup Location -->
          <div class="location-row">
            <ion-icon name="location" class="location-icon pickup-icon"></ion-icon>
            <div class="location-content">
              <span class="location-label">{{ 'BOOKINGS.pickup' | translate }}</span>
              <span class="location-value">{{ booking.pickupAddress || 'N/A' }}</span>
            </div>
          </div>

          <!-- Destination Location -->
          <div class="location-row">
            <ion-icon name="location" class="location-icon destination-icon"></ion-icon>
            <div class="location-content">
              <span class="location-label">{{ 'BOOKINGS.destination' | translate }}</span>
              <span class="location-value">{{ booking.dropoffAddress || 'N/A' }}</span>
            </div>
          </div>

          <!-- Fare Display -->
          <div class="fare-section">
            <div class="fare-label">{{ 'BOOKINGS.fare' | translate }}</div>
            <div class="fare-amount">₹{{ booking.fare || 'N/A' }}</div>
          </div>

          <!-- Completed Time (if available) -->
          <div *ngIf="booking.actualEndTime" class="completed-section">
            <ion-icon name="checkmark-circle-outline" class="completed-icon"></ion-icon>
            <span class="completed-text">
              Completed: {{ formatDate(booking.actualEndTime) }} at {{ formatTime(booking.actualEndTime) }}
            </span>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-list>

    <!-- Load More Button for Past Rides -->
    <div *ngIf="!isLoading && hasMorePast()" class="ion-text-center ion-padding">
      <ion-button 
        expand="block" 
        fill="outline" 
        (click)="loadMorePast()"
        class="load-more-btn">
        <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
        Load More ({{ pastBookings.length - pastDisplayCount }} remaining)
      </ion-button>
    </div>
  </div>
</ion-content>

<ion-header [translucent]="false" class="ion-no-border payment-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/tabs/tab1" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>{{ 'PAYMENT.title' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="payment-content" [scrollY]="true">
  <!-- Error State -->
  <div *ngIf="paymentError" class="error-container">
    <ion-icon name="alert-circle-outline" color="danger" style="font-size: 64px;"></ion-icon>
    <h2>Payment Error</h2>
    <p>{{ paymentError }}</p>
    <ion-button expand="block" fill="outline" (click)="retryPayment()" class="retry-button">
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      Try Again
    </ion-button>
    <ion-button expand="block" fill="clear" (click)="goBack()" class="back-button">
      Go Back
    </ion-button>
  </div>

  <div class="payment-container" *ngIf="!paymentError">
    <!-- Payment Summary -->
    <div class="payment-summary">
      <h2>{{ 'PAYMENT.paymentSummary' | translate }}</h2>
      <div class="summary-details">
        <div class="summary-row">
          <span>{{ 'PAYMENT.baseFare' | translate }}</span>
          <span>₹{{baseFare}}</span>
        </div>
        <div class="summary-row" *ngIf="distanceFare > 0">
          <span>Distance Fare</span>
          <span>₹{{distanceFare}}</span>
        </div>
        <div class="summary-row" *ngIf="distanceFare > 0">
          <span>Subtotal</span>
          <span>₹{{subtotal}}</span>
        </div>
        <div class="summary-row info-row" *ngIf="minimumFareApplied">
          <span><ion-icon name="information-circle-outline"></ion-icon> Minimum Fare Applied</span>
          <span>₹{{finalFare}}</span>
        </div>
        <div class="summary-row" *ngIf="promoApplied">
          <span class="discount-text">{{ 'PAYMENT.discountApplied' | translate }}</span>
          <span class="discount-amount">-₹{{discountAmount}}</span>
        </div>
        <div class="summary-row total">
          <span>{{ 'PAYMENT.totalAmount' | translate }}</span>
          <span>₹{{totalAmount}}</span>
        </div>
        <div class="summary-row info-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
          <span style="font-size: 12px; color: #666;">
            <ion-icon name="information-circle-outline" style="vertical-align: middle;"></ion-icon>
            Final fare may vary based on actual ride duration
          </span>
        </div>
      </div>
    </div>

    <!-- Ride For Section -->
    <div class="ride-for-section">
      <h2>Booking for</h2>
      <ion-segment [(ngModel)]="rideFor" (ionChange)="onRideForChange($event)">
        <ion-segment-button value="SELF">
          <ion-label>Myself</ion-label>
        </ion-segment-button>
        <ion-segment-button value="OTHER">
          <ion-label>Other Person</ion-label>
        </ion-segment-button>
      </ion-segment>

      <!-- Passenger Form (shown when "Other Person" is selected) -->
      <div class="passenger-form" *ngIf="rideFor === 'OTHER'">
        <div class="form-group">
          <ion-item lines="full" class="form-item">
            <ion-label position="stacked">Passenger Name <span class="required">*</span></ion-label>
            <ion-input 
              [(ngModel)]="passengerName" 
              type="text"
              placeholder="Enter passenger name"
              [class.invalid]="passengerNameError"
              (ionBlur)="validatePassengerName()">
            </ion-input>
          </ion-item>
          <div class="error-message" *ngIf="passengerNameError">
            {{ passengerNameError }}
          </div>
        </div>

        <div class="form-group">
          <ion-item lines="full" class="form-item">
            <ion-label position="stacked">Passenger Phone <span class="required">*</span></ion-label>
            <ion-input 
              [(ngModel)]="passengerPhone" 
              type="tel"
              placeholder="Enter 10-digit phone number"
              maxlength="10"
              [class.invalid]="passengerPhoneError"
              (ionInput)="formatPhoneNumber()"
              (ionBlur)="validatePassengerPhone()">
            </ion-input>
          </ion-item>
          <div class="error-message" *ngIf="passengerPhoneError">
            {{ passengerPhoneError }}
          </div>
        </div>

        <div class="form-group">
          <ion-item lines="full" class="form-item">
            <ion-label position="stacked">Relation (Optional)</ion-label>
            <ion-select [(ngModel)]="passengerRelation" placeholder="Select relation">
              <ion-select-option value="Family">Family</ion-select-option>
              <ion-select-option value="Friend">Friend</ion-select-option>
              <ion-select-option value="Colleague">Colleague</ion-select-option>
              <ion-select-option value="Other">Other</ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <div class="form-group">
          <ion-item lines="full" class="form-item">
            <ion-label position="stacked">Notes (Optional)</ion-label>
            <ion-textarea 
              [(ngModel)]="passengerNotes" 
              placeholder="Add any special instructions..."
              rows="3"
              maxlength="200">
            </ion-textarea>
          </ion-item>
          <div class="char-count">{{ passengerNotes.length }}/200</div>
        </div>

        <div class="form-group">
          <ion-item lines="none" class="form-item">
            <ion-label>Use my contact details instead</ion-label>
            <ion-toggle [(ngModel)]="useRiderContact" (ionChange)="onUseRiderContactChange()"></ion-toggle>
          </ion-item>
          <p class="helper-text">Driver will contact you instead of the passenger</p>
        </div>
      </div>
    </div>

    <!-- Payment Methods -->
    <div class="payment-methods">
      <h2>{{ 'PAYMENT.selectPaymentMethod' | translate }}</h2>
      <ion-list lines="none">
        <ion-radio-group justify="space-between" [(ngModel)]="selectedPaymentMethod" (ionChange)="onPaymentMethodChange($event)">
          <ion-item lines="none" class="payment-method-item" [class.insufficient-balance]="isWalletSelected && insufficientBalance">
            <ion-avatar slot="start">
              <ion-icon name="wallet-outline"></ion-icon>
            </ion-avatar>
            <ion-label>
              <h3>{{ 'PAYMENT.wallet' | translate }}</h3>
              <p>{{ 'PAYMENT.availableBalance' | translate }}: ₹{{walletBalance}}</p>
              <p *ngIf="isWalletSelected && insufficientBalance" class="error-message">
                {{ 'PAYMENT.insufficientBalance' | translate: {amount: (totalAmount - walletBalance)} }}
              </p>
            </ion-label>
            <ion-radio slot="end" value="wallet"></ion-radio>
          </ion-item>

          <ion-item lines="none" class="payment-method-item">
            <ion-avatar slot="start">
              <ion-icon name="cash-outline"></ion-icon>
            </ion-avatar>
            <ion-label>
              <h3>{{ 'PAYMENT.cash' | translate }}</h3>
              <p>{{ 'PAYMENT.payWithCash' | translate }}</p>
            </ion-label>
            <ion-radio slot="end" value="cash"></ion-radio>
          </ion-item>

          <ion-item lines="none" class="payment-method-item">
            <ion-avatar slot="start">
              <ion-icon name="card-outline"></ion-icon>
            </ion-avatar>
            <ion-label>
              <h3>Pay Online</h3>
              <p>Pay after ride with card, UPI, or netbanking</p>
            </ion-label>
            <ion-radio slot="end" value="razorpay"></ion-radio>
          </ion-item>
        </ion-radio-group>
      </ion-list>
    </div>

    <!-- Promo Code -->
    <div class="promo-section">
      <div class="promo-input-container">
        <ion-input 
          [(ngModel)]="promoCode" 
          [placeholder]="'PAYMENT.enterPromoCode' | translate"
          [clearOnEdit]="true"
          class="promo-input">
        </ion-input>
        <ion-button 
          fill="clear" 
          (click)="applyPromo()"
          [disabled]="!promoCode || promoApplied">
          {{ 'PAYMENT.apply' | translate }}
        </ion-button>
      </div>
      <div class="promo-message" *ngIf="promoMessage">
        <ion-icon [name]="promoApplied ? 'checkmark-circle' : 'alert-circle'" 
                 [color]="promoApplied ? 'success' : 'danger'">
        </ion-icon>
        <span>{{promoMessage}}</span>
      </div>
    </div>

    <!-- Continue to Pay Button -->
    <div class="payment-action">
      <ion-button 
        expand="block" 
        class="pay-button" 
        (click)="proceedToPayment()"
        [disabled]="false">
        <ion-icon name="card-outline" slot="start"></ion-icon>
        <ng-container *ngIf="isWalletSelected && !insufficientBalance">
          Pay from Wallet ₹{{totalAmount}}
        </ng-container>
        <ng-container *ngIf="isWalletSelected && insufficientBalance">
          Pay ₹{{getRemainingAmount()}} now + Wallet ₹{{getWalletAmountUsed()}}
        </ng-container>
        <ng-container *ngIf="!isWalletSelected && selectedPaymentMethod === 'cash'">
          Pay ₹{{totalAmount}}
        </ng-container>
        <ng-container *ngIf="!isWalletSelected && selectedPaymentMethod === 'razorpay'">
          Request Ride (Pay ₹{{totalAmount}} after ride)
        </ng-container>
      </ion-button>
    </div>
  </div>
</ion-content>

<ion-header [translucent]="false" class="ion-no-border payment-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>{{ 'PAYMENT.title' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="payment-content" [scrollY]="true">
  <div class="payment-container">
    <!-- Payment Summary -->
    <div class="payment-summary">
      <h2>{{ 'PAYMENT.paymentSummary' | translate }}</h2>
      <div class="summary-details">
        <div class="summary-row">
          <span>{{ 'PAYMENT.baseFare' | translate }}</span>
          <span>₹{{baseFare}}</span>
        </div>
        <div class="summary-row" *ngIf="distanceFare > 0">
          <span>Distance Fare</span>
          <span>₹{{distanceFare}}</span>
        </div>
        <div class="summary-row" *ngIf="distanceFare > 0">
          <span>Subtotal</span>
          <span>₹{{subtotal}}</span>
        </div>
        <div class="summary-row info-row" *ngIf="minimumFareApplied">
          <span><ion-icon name="information-circle-outline"></ion-icon> Minimum Fare Applied</span>
          <span>₹{{finalFare}}</span>
        </div>
        <div class="summary-row" *ngIf="promoApplied">
          <span class="discount-text">{{ 'PAYMENT.discountApplied' | translate }}</span>
          <span class="discount-amount">-₹{{discountAmount}}</span>
        </div>
        <div class="summary-row" *ngIf="selectedPaymentMethod === 'razorpay' && canUseWallet && walletAmountToUse > 0">
          <span>{{ 'PAYMENT.walletPayment' | translate }}</span>
          <span>₹{{walletAmountToUse}}</span>
        </div>
        <div class="summary-row" *ngIf="selectedPaymentMethod === 'razorpay' && canUseWallet && walletAmountToUse > 0">
          <span>{{ 'PAYMENT.onlinePayment' | translate }}</span>
          <span>₹{{razorpayAmountToPay}}</span>
        </div>
        <div class="summary-row total">
          <span>{{ 'PAYMENT.totalAmount' | translate }}</span>
          <span>₹{{totalAmount}}</span>
        </div>
      </div>
    </div>

    <!-- Payment Methods -->
    <div class="payment-methods">
      <h2>{{ 'PAYMENT.selectPaymentMethod' | translate }}</h2>
      <ion-list lines="none">
        <ion-radio-group justify="space-between" [(ngModel)]="selectedPaymentMethod" (ionChange)="onPaymentMethodChange($event)">
          <ion-item lines="none" class="payment-method-item" [class.insufficient-balance]="isWalletSelected && insufficientBalance">
            <ion-avatar slot="start">
              <ion-icon name="wallet-outline"></ion-icon>
            </ion-avatar>
            <ion-label>
              <h3>{{ 'PAYMENT.wallet' | translate }}</h3>
              <p>{{ 'PAYMENT.availableBalance' | translate }}: ₹{{walletBalance}}</p>
              <p *ngIf="isWalletSelected && insufficientBalance" class="error-message">
                {{ 'PAYMENT.insufficientBalance' | translate: {amount: (totalAmount - walletBalance)} }}
              </p>
            </ion-label>
            <ion-radio slot="end" value="wallet"></ion-radio>
          </ion-item>

          <ion-item lines="none" class="payment-method-item">
            <ion-avatar slot="start">
              <ion-icon name="cash-outline"></ion-icon>
            </ion-avatar>
            <ion-label>
              <h3>{{ 'PAYMENT.cash' | translate }}</h3>
              <p>{{ 'PAYMENT.payWithCash' | translate }}</p>
            </ion-label>
            <ion-radio slot="end" value="cash"></ion-radio>
          </ion-item>

          <ion-item lines="none" class="payment-method-item">
            <ion-avatar slot="start">
              <ion-icon name="card-outline"></ion-icon>
            </ion-avatar>
            <ion-label>
              <h3>{{ 'PAYMENT.onlinePayment' | translate }}</h3>
              <p *ngIf="canUseWallet && walletAmountToUse > 0">
                Pay ₹{{razorpayAmountToPay}} ({{ 'PAYMENT.wallet' | translate }}: ₹{{walletAmountToUse}})
              </p>
              <p *ngIf="!canUseWallet || walletAmountToUse === 0">
                {{ 'PAYMENT.payUsingUPI' | translate }}
              </p>
            </ion-label>
            <ion-radio slot="end" value="razorpay"></ion-radio>
          </ion-item>
        </ion-radio-group>
      </ion-list>
    </div>

    <!-- Hybrid Payment Info -->
    <div class="hybrid-payment-info" *ngIf="selectedPaymentMethod === 'razorpay' && canUseWallet && walletAmountToUse > 0">
      <ion-icon name="information-circle-outline" color="primary"></ion-icon>
      <p>
        {{ 'PAYMENT.hybridPaymentInfo' | translate: {walletAmount: walletAmountToUse, razorpayAmount: razorpayAmountToPay} }}
      </p>
    </div>

    <!-- Promo Code -->
    <div class="promo-section">
      <div class="promo-input-container">
        <ion-input 
          [(ngModel)]="promoCode" 
          [placeholder]="'PAYMENT.enterPromoCode' | translate"
          [clearOnEdit]="true"
          class="promo-input">
        </ion-input>
        <ion-button 
          fill="clear" 
          (click)="applyPromo()"
          [disabled]="!promoCode || promoApplied">
          {{ 'PAYMENT.apply' | translate }}
        </ion-button>
      </div>
      <div class="promo-message" *ngIf="promoMessage">
        <ion-icon [name]="promoApplied ? 'checkmark-circle' : 'alert-circle'" 
                 [color]="promoApplied ? 'success' : 'danger'">
        </ion-icon>
        <span>{{promoMessage}}</span>
      </div>
    </div>

    <!-- Continue to Pay Button -->
    <div class="payment-action">
      <ion-button 
        expand="block" 
        class="pay-button" 
        (click)="proceedToPayment()"
        [disabled]="isWalletSelected && insufficientBalance">
        <ion-icon name="card-outline" slot="start"></ion-icon>
        <ng-container *ngIf="isWalletSelected">
          Pay from Wallet ₹{{totalAmount}}
        </ng-container>
        <ng-container *ngIf="!isWalletSelected && selectedPaymentMethod === 'cash'">
          Pay ₹{{totalAmount}}
        </ng-container>
        <ng-container *ngIf="selectedPaymentMethod === 'razorpay' && canUseWallet && walletAmountToUse > 0">
          Pay ₹{{razorpayAmountToPay}} Online
        </ng-container>
        <ng-container *ngIf="selectedPaymentMethod === 'razorpay' && (!canUseWallet || walletAmountToUse === 0)">
          Pay ₹{{totalAmount}} Online
        </ng-container>
      </ion-button>
    </div>
  </div>
</ion-content>

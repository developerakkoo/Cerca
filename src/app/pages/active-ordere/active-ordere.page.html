<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button 
        defaultHref="/tabs/tab1" 
        text=""
        (click)="handleBackButton()">
      </ion-back-button>
    </ion-buttons>
    <ion-title>Track Ride</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="map-content">
  <!-- Google Map -->
  <capacitor-google-map id="mymap" #mymap></capacitor-google-map>

  
  <!-- Driver Details Modal (Sheet) -->
  <ion-modal
    [isOpen]="isDriverModalOpen"
    [initialBreakpoint]="0.5"
    [breakpoints]="[0.3, 0.5, 0.9]"
    [backdropDismiss]="false"
    [showBackdrop]="false"
  >
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{statusText}}</ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-content>
        <ion-item lines="none" *ngIf="!isDriverArrived && currentRideStatus !== 'in_progress'">
          <ion-label color="primary">
            <h2>ETA: {{arrivalTime}} mins</h2>
          </ion-label>
        </ion-item>
        <ion-item lines="none" *ngIf="currentRideStatus === 'in_progress'">
          <ion-label color="success">
            <h2>Enjoy your ride! ðŸš—</h2>
          </ion-label>
        </ion-item>
        <ion-list *ngIf="driver">
          <ion-item button (click)="navigateToDriverDetails()">
            <ion-avatar slot="start">
              <img src="assets/user.png" alt="Driver Profile" />
            </ion-avatar>
            <ion-label>
              <h2>{{driver?.name}}</h2>
              <p>
                <ion-icon name="star" color="warning"></ion-icon>
                {{driver?.rating}}
              </p>
            </ion-label>
            <ion-label slot="end" text-end>
              <h3>{{driver?.carNumber || "MHXXXX"}}</h3>
              <p>{{driver?.carType || "XXXX"}}</p>
            </ion-label>
          </ion-item>
        </ion-list>

        <ion-grid *ngIf="currentRideStatus !== 'completed' && currentRideStatus !== 'cancelled'">
          <ion-row>
            <ion-col size="6">
              <ion-button expand="block" fill="clear" (click)="chatWithDriver()" class="chat-button">
                <ion-icon name="chatbubble-outline" slot="start"></ion-icon>
                Chat
                <ion-badge *ngIf="unreadMessageCount > 0" color="danger" class="chat-badge">
                  {{ unreadMessageCount }}
                </ion-badge>
              </ion-button>
            </ion-col>
            <ion-col size="6">
              <ion-button expand="block" fill="clear">
                <ion-icon name="call-outline" slot="start"></ion-icon>
                Call
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>

        <ion-card *ngIf="!showRating && driver && (currentRideStatus === 'arrived' || currentRideStatus === 'in_progress')">
          <ion-card-header>
            <ion-card-title>Share OTP with Driver</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-text color="primary">
              <h1 style="font-size: 2em; letter-spacing: 0.2em; text-align: center; margin: 16px 0;">
                {{driver?.otp}}
              </h1>
            </ion-text>
            <ion-text color="medium">
              <p style="text-align: center; font-style: italic;">
                <span *ngIf="currentRideStatus === 'arrived'">Share this OTP to start your ride</span>
                <span *ngIf="currentRideStatus === 'in_progress'">Share this OTP to end your ride</span>
              </p>
            </ion-text>
          </ion-card-content>
        </ion-card>

        <ion-list *ngIf="!showRating">
          <ion-item>
            <ion-icon name="location" slot="start" color="success"></ion-icon>
            <ion-label>
              <h3>Pickup</h3>
              <p>{{pickupLocation}}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="location" slot="start" color="danger"></ion-icon>
            <ion-label>
              <h3>Destination</h3>
              <p>{{destinationLocation}}</p>
            </ion-label>
          </ion-item>
        </ion-list>

        <ion-button
          expand="block"
          fill="clear"
          color="danger"
          *ngIf="currentRideStatus !== 'completed' && currentRideStatus !== 'cancelled' && currentRideStatus !== 'idle'"
          (click)="triggerEmergency()"
        >
          <ion-icon name="warning-outline" slot="start"></ion-icon>
          Emergency
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Rating Modal -->
  <div class="rating-modal" *ngIf="showRating" [class.show]="showRating">
    <div class="rating-content">
      <h2>How was your ride?</h2>
      <div class="emoji-grid">
        <div
          class="emoji-item"
          *ngFor="let emoji of emojis"
          [class.selected]="selectedEmoji === emoji.value"
          (click)="selectEmoji(emoji.value)"
        >
          <span class="emoji">{{emoji.emoji}}</span>
          <span class="emoji-label">{{emoji.label}}</span>
        </div>
      </div>
      <ion-button expand="block" class="submit-rating" (click)="submitRating()">
        Submit
      </ion-button>
    </div>
  </div>

  <!-- Thank You Alert -->
  <div class="thank-you-alert" *ngIf="showThankYou" [class.show]="showThankYou">
    <div class="thank-you-content">
      <div class="checkmark">âœ“</div>
      <h2>Thank You!</h2>
      <p>Your feedback helps us improve</p>
    </div>
  </div>

  <!-- Rate Us Modal -->
  <div class="rate-us-modal" *ngIf="showRateUs" [class.show]="showRateUs">
    <div class="rate-us-content">
      <h2>Enjoying Cerca?</h2>
      <p>Please rate us on the app store</p>
      <div class="store-buttons">
        <ion-button fill="clear" class="store-btn" (click)="rateOnStore()">
          <ion-icon name="logo-google-playstore"></ion-icon>
          Rate on Play Store
        </ion-button>
        <ion-button fill="clear" class="store-btn" (click)="rateOnStore()">
          <ion-icon name="logo-apple"></ion-icon>
          Rate on App Store
        </ion-button>
      </div>
      <ion-button fill="clear" class="skip-btn" (click)="skipRating()">
        Maybe Later
      </ion-button>
    </div>
  </div>
</ion-content>
